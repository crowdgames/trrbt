---
name: rust-layer
tree:
  type: order
  children:
  - type: random-try
    children:
    - type: set-board
      pattern:
        main: .  .  .  .  X  X  X  X  X;
              .  .  .  .  X  _  _  _  X;
              .  .  .  .  X  _  P  _  X;
              .  .  .  .  X  _  _  _  X;
              .  .  .  .  .  .  _  .  .;
              .  .  .  .  B  _  _  .  .;
              .  .  .  .  _  .  .  .  .;
              X  _  _  _  _  _  _  _  X;
              X  _  _  _  _  _  _  _  X;
              X  _  _  X  X  X  _  _  X;
              X  _  _  _  F  _  _  _  X;
              X  _  _  _  _  _  _  _  X;
              .  .  .  .  B  .  .  .  .;
              X  _  _  _  _  _  _  _  X;
              X  _  _  _  X  _  _  _  X;
              X  _  F  _  X  _  F  _  X;
              X  _  _  _  X  _  _  _  X;
              X  _  _  _  _  _  _  _  X;
              .  .  .  .  _  .  .  .  .;
              .  .  .  .  B  _  B  .  .;
              .  .  .  .  .  .  _  .  .;
              .  .  .  .  X  _  _  _  X;
              .  .  .  .  X  _  O  _  X;
              .  .  .  .  X  _  _  _  X;
              .  .  .  .  X  X  X  X  X;
        path: .  .  .  .  _  _  _  _  _;
              .  .  .  .  _  _  _  _  _;
              .  .  .  .  _  _  _  _  _;
              .  .  .  .  _  _  _  _  _;
              .  .  .  .  .  .  _  .  .;
              .  .  .  .  _  _  _  .  .;
              .  .  .  .  _  .  .  .  .;
              _  _  _  _  _  _  _  _  _;
              _  _  _  _  _  _  _  _  _;
              _  _  _  _  _  _  _  _  _;
              _  _  _  _  _  _  _  _  _;
              _  _  _  _  _  _  _  _  _;
              .  .  .  .  _  .  .  .  .;
              _  _  _  _  _  _  _  _  _;
              _  _  _  _  _  _  _  _  _;
              _  _  _  _  _  _  _  _  _;
              _  _  _  _  _  _  _  _  _;
              _  _  _  _  _  _  _  _  _;
              .  .  .  .  _  .  .  .  .;
              .  .  .  .  _  _  _  .  .;
              .  .  .  .  .  .  _  .  .;
              .  .  .  .  _  _  _  _  _;
              .  .  .  .  _  _  _  _  _;
              .  .  .  .  _  _  _  _  _;
              .  .  .  .  _  _  _  _  _;
  - type: loop-until-all
    nid: gameloop
    children:
    - type: x-replace-only
      what: p
      with:
      - P
      - P:A1
      - P:A2
      - P:A3
      children:
      - type: x-replace-only
        what: a
        with:
        - _
        - A1
        - A2
        - A3
        - T1
        - E
        - F
        children:
        - type: x-replace-only
          what: s
          with:
          - X
          - B
          children:
          - type: x-replace-only
            what: d
            with:
            - '<'
            - '>'
            - ^
            - v
            children:
            - type: x-spin
              children:
              - type: player
                pid: 1
                children:
                - type: rewrite
                  lhs: P  _
                  rhs: R  P
                - type: rewrite
                  lhs: P  O
                  rhs: _  W
                - type: rewrite
                  lhs: P  B
                  rhs: P  _
                - type: rewrite
                  lhs: P  E
                  rhs: P  _
                - type: rewrite
                  lhs: P  F
                  rhs: P  _
            - type: loop-until-all
              children:
              - type: rewrite
                lhs:
                  main: P
                  path: _
                rhs:
                  path: P
              - type: rewrite
                lhs:
                  main: R
                  path: _
                rhs:
                  main: _
                  path: R
              - type: rewrite
                lhs:
                  main: s
                  path: _
                rhs:
                  path: S
                  
            - type: loop-until-all
              children:
              - type: rewrite
                layer: path
                lhs: 'P _'
                rhs: 'P <'
              - type: rewrite
                layer: path
                lhs: '_ P'
                rhs: '> P'
              - type: rewrite
                layer: path
                lhs: 'P; _'
                rhs: 'P; ^'
              - type: rewrite
                layer: path
                lhs: '_; P'
                rhs: 'v; P'
            - type: loop-until-all
              children:
              - type: rewrite
                layer: path
                lhs: 'R _'
                rhs: 'R <'
              - type: rewrite
                layer: path
                lhs: '_ R'
                rhs: '> R'
              - type: rewrite
                layer: path
                lhs: 'R; _'
                rhs: 'R; ^'
              - type: rewrite
                layer: path
                lhs: '_; R'
                rhs: 'v; R'
            - type: loop-until-all
              children:
              - type: rewrite
                layer: path
                lhs: 'P R'
                rhs: 'P <'
              - type: rewrite
                layer: path
                lhs: 'R P'
                rhs: '> P'
              - type: rewrite
                layer: path
                lhs: 'P; R'
                rhs: 'P; ^'
              - type: rewrite
                layer: path
                lhs: 'R; P'
                rhs: 'v; P'
            - type: loop-until-all
              children:

              - type: x-ident
                nid: arrow-equal
                children:
                - type: loop-until-all
                  children:
                  - type: x-spin
                    children:
                    - type: rewrite
                      layer: path
                      lhs: '< _'
                      rhs: '< ='
                    - type: rewrite
                      layer: path
                      lhs: '> _'
                      rhs: '> ='
                    - type: rewrite
                      layer: path
                      lhs: '^ _'
                      rhs: '^ ='
                    - type: rewrite
                      layer: path
                      lhs: 'v _'
                      rhs: 'v ='

              - type: x-ident
                nid: arrow-left-right
                children:
                - type: loop-until-all
                  children:
                  - type: rewrite
                    layer: path
                    lhs: '< ='
                    rhs: '< <'
                  - type: rewrite
                    layer: path
                    lhs: '^ ='
                    rhs: '^ <'
                  - type: rewrite
                    layer: path
                    lhs: 'v ='
                    rhs: 'v <'

                  - type: rewrite
                    layer: path
                    lhs: '= >'
                    rhs: '> >'
                  - type: rewrite
                    layer: path
                    lhs: '= ^'
                    rhs: '> ^'
                  - type: rewrite
                    layer: path
                    lhs: '= v'
                    rhs: '> v'

              - type: x-ident
                nid: arrow-up-down
                children:
                - type: loop-until-all
                  children:
                  - type: rewrite
                    layer: path
                    lhs: '<; ='
                    rhs: '<; ^'
                  - type: rewrite
                    layer: path
                    lhs: '>; ='
                    rhs: '>; ^'
                  - type: rewrite
                    layer: path
                    lhs: '^; ='
                    rhs: '^; ^'

                  - type: rewrite
                    layer: path
                    lhs: '=; <'
                    rhs: 'v; <'
                  - type: rewrite
                    layer: path
                    lhs: '=; >'
                    rhs: 'v; >'
                  - type: rewrite
                    layer: path
                    lhs: '=; v'
                    rhs: 'v; v'
                    
              - type: x-link
                target: arrow-equal
              - type: x-link
                target: arrow-up-down
              - type: x-link
                target: arrow-left-right
            - type: player
              pid: 1
              children:
              - type: rewrite
                lhs: P
                rhs: P
          
            - type: order
              comment: move enemies
              children:
              - type: loop-until-all
                children:
                - type: rewrite
                  lhs:
                    main: 'P  E'
                    path: '.  <'
                  rhs:
                    main: 'E* _'
                - type: rewrite
                  lhs:
                    main: 'E  P'
                    path: '>  .'
                  rhs:
                    main: '_ E*'
                - type: rewrite
                  lhs:
                    main: 'P ; E'
                    path: '. ; ^'
                  rhs:
                    main: 'E*; _'
                - type: rewrite
                  lhs:
                    main: 'E ; P'
                    path: 'v ; .'
                  rhs:
                    main: '_ ; E*'
              - type: loop-until-all
                children:
                - type: rewrite
                  lhs:
                    main: '_  E'
                    path: '.  <'
                  rhs:
                    main: 'E* _'
                - type: rewrite
                  lhs:
                    main: 'E  _'
                    path: '>  .'
                  rhs:
                    main: '_ E*'
                - type: rewrite
                  lhs:
                    main: '_ ; E'
                    path: '. ; ^'
                  rhs:
                    main: 'E*; _'
                - type: rewrite
                  lhs:
                    main: 'E ; _'
                    path: 'v ; .'
                  rhs:
                    main: '_ ; E*'

            - type: loop-until-all
              comment: clear enemy movement
              children:
              - type: rewrite
                lhs: E*
                rhs: E
                
            - type: loop-until-all
              comment: clear path
              children:
              - type: rewrite
                layer: path
                lhs: P
                rhs: _
              - type: rewrite
                layer: path
                lhs: S
                rhs: _
              - type: rewrite
                layer: path
                lhs: d
                rhs: _

            - type: order
              comment: cycle enemies
              children:
              - type: loop-until-all
                children:
                - type: rewrite
                  lhs: F
                  rhs: E*
                - type: rewrite
                  lhs: E
                  rhs: F*
              - type: loop-until-all
                children:
                - type: rewrite
                  lhs: E*
                  rhs: E
                - type: rewrite
                  lhs: F*
                  rhs: F
         
            - type: none
              children:
              - type: match
                pattern: S1
              - type: loop-until-all
                children:
                - type: rewrite
                  lhs: D1
                  rhs: _
                - type: rewrite
                  lhs: A1
                  rhs: E
            - type: none
              children:
              - type: match
                pattern: S2
              - type: loop-until-all
                children:
                - type: rewrite
                  lhs: D2
                  rhs: _
                - type: rewrite
                  lhs: A2
                  rhs: E
            - type: none
              children:
              - type: match
                pattern: S3
              - type: loop-until-all
                children:
                - type: rewrite
                  lhs: D3
                  rhs: _
                - type: rewrite
                  lhs: A3
                  rhs: E
            - type: none
              children:
              - type: match
                pattern: T1
              - type: loop-until-all
                children:
                - type: rewrite
                  lhs: N1
                  rhs: F
            - type: win
              pid: 1
              children:
              - type: match
                pattern: W
            - type: lose
              pid: 1
              children:
              - type: none
                children:
                - type: match
                  pattern: p
