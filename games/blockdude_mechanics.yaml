---
name: blockdude mechanics
tree:
  type: order
  nid: gameroot
  children:
  - type: order
    comment: set up and play
    children:
    - type: order
      comment: set up facing layer
      children:
      - type: order 
        comment: set player direction
        children:
        # - type: layer-template
        #   what: face
        #   with: _
        - type: rewrite
          comment: start player facing left if unset
          lhs: . P
          rhs: . <P
        # - type: rewrite
        #   comment: face left
        #   lhs: 
        #     main: . <P
        #     face: _ _
        #   rhs: 
        #     face: F P
        # - type: rewrite
        #   comment: face right
        #   lhs: 
        #     main: P> .
        #     face: _ _
        #   rhs: 
        #     face: P F
    # - type: loop-until-all
    #   comment: mark floating blocks
    #   children:
    #   - type: rewrite
    #     lhs: B;_
    #     rhs: Bf;_
    # - type: loop-until-all
    #   nid: gameloop
    #   children:
    #   - type: all
    #     children:
    #     - type: x-replace-only
    #       comment: player
    #       what: P
    #       with:
    #       - P>
    #       - <P
    #       children:
    #       - type: match
    #         pattern: P
    #       - type: order
    #         comment: genericize
    #         children:
    #         - type: x-replace-only
    #           comment: solid tiles
    #           what: S
    #           with:
    #           - B
    #           - Bf
    #           - W
    #           children:
    #           - type: x-replace-only
    #             comment: not holding a block
    #             what: X
    #             with:
    #             - W
    #             - _
    #             - Bf
    #             children:
    #             - type: player
    #               pid: 1
    #               children:
    #               - type: x-mirror
    #                 comment: regardless of block
    #                 children:
    #                 - type: rewrite
    #                   comment: stay still
    #                   desc: wait
    #                   lhs: P
    #                   rhs: P
    #                 - type: rewrite
    #                   comment: change directions
    #                   layer: face
    #                   desc: turn
    #                   lhs: _ P F ;
    #                   rhs: F P _ ;
    #                 - type: x-mirror
    #                   comment: door
    #                   children:
    #                   - type: rewrite
    #                     comment: walk through door
    #                     desc: door
    #                     lhs: 
    #                       main: . P D ;
    #                       face: . P F ;
    #                     rhs: 
    #                       main: _ D ;
    #                       face: _ _ ;
    #                     button: right
    #                   - type: rewrite
    #                     comment: jump to door
    #                     desc: jump_door
    #                     lhs:  
    #                       main: _ D ;
    #                             P S ;
    #                       face: _ _ ;
    #                             P F ;
    #                     rhs:  
    #                       main: _ D ;
    #                             _ S ;
    #                       face: _ _ ;
    #                             _ _ ;
    #                     button: up
    #                 - type: x-mirror
    #                   comment: movement without a block
    #                   children:
    #                   - type: rewrite
    #                     comment: walk
    #                     desc: walk
    #                     lhs:
    #                       main: X . . ;
    #                             P _ . ;
    #                       face: _ _ _ ;
    #                             P F _ ;
    #                     rhs:  
    #                       main: X . . ;
    #                             _ P . ;
    #                       face: _ _ _ ;
    #                             _ P F ;
    #                     button: right
    #                   - type: rewrite
    #                     comment: jump
    #                     desc: jump
    #                     lhs:  
    #                       main: _ _ . ;
    #                             P S . ;
    #                       face: _ _ _ ;
    #                             P F _ ;
    #                     rhs:  
    #                       main: _ P . ;
    #                             _ S . ;
    #                       face: _ P F ;
    #                             _ _ _ ;
    #                     button: up
    #                 - type: x-mirror
    #                   comment: block handling
    #                   children:
    #                   - type: x-replace-only
    #                     comment: block-agnostic
    #                     what: B
    #                     with:
    #                     - B
    #                     - Bf
    #                     children:
    #                     - type: x-mirror
    #                       comment: blocks adjacent to player
    #                       children:
    #                       - type: rewrite
    #                         comment: take from next to
    #                         desc: take
    #                         lhs:  
    #                           main: _ _ ;
    #                                 P B ;
    #                           face: _ _ ;
    #                                 P F ;
    #                         rhs:  
    #                           main: B' _ ;
    #                                 P  _ ;
    #                         button: space
    #                       - type: rewrite
    #                         comment: drop next to
    #                         desc: drop
    #                         lhs:  
    #                           main: B _ ;
    #                                 P _ ;
    #                           face: _ _ ;
    #                                 P F ;
    #                         rhs:  
    #                           main: _ _ ;
    #                                 P B ;
    #                         button: space
    #                     - type: x-mirror
    #                       comment: blocks one up from player
    #                       children:
    #                       - type: rewrite
    #                         comment: take from tower
    #                         desc: take_above
    #                         lhs:  
    #                           main: . X ;
    #                                 _ B ;
    #                                 P . ;
    #                           face: _ _ ;
    #                                 _ _ ;
    #                                 P F ;
    #                         rhs:  
    #                           main: .  X ;
    #                                 B' _ ;
    #                                 P  . ;
    #                         button: space
    #                       - type: rewrite
    #                         comment: drop onto tower
    #                         desc: drop_onto
    #                         lhs:  
    #                           main: B _ ;
    #                                 P S ;
    #                           face: _ _ ;
    #                                 P F ;
    #                         rhs:  
    #                           main: _ B ;
    #                                 P S ;
    #                         button: space
    #                   - type: x-mirror
    #                     comment: move with block
    #                     children:
    #                     - type: rewrite
    #                       comment: walk with block
    #                       desc: walk_block
    #                       lhs:  
    #                         main: B _ . ;
    #                               P _ . ;
    #                               S . . ;
    #                         face: _ _ _ ;
    #                               P F _ ;
    #                               _ _ _ ;
    #                       rhs:  
    #                         main: _ B . ;
    #                               _ P . ;
    #                               S . . ;
    #                         face: _ _ _ ;
    #                               _ P F ;
    #                               _ _ _ ;
    #                       button: right
    #                     - type: rewrite
    #                       comment: jump with block
    #                       desc: jump_block
    #                       lhs:  
    #                         main: _ _ . ;
    #                               B _ . ;
    #                               P S . ;
    #                         face: _ _ _ ;
    #                               _ _ _ ;
    #                               P F _ ;
    #                       rhs:  
    #                         main: _ B . ;
    #                               _ P . ;
    #                               _ S . ;
    #                         face: _ _ _ ;
    #                               _ P F ;
    #                               _ _ _ ;
    #                       button: up
    #           - type: loop-until-all
    #             comment: unmark taken blocks
    #             children:
    #             - type: rewrite
    #               comment: unmark taken blocks
    #               lhs: B'
    #               rhs: B
    #             - type: rewrite
    #               comment: unmark taken blocks (Bfs become normal blocks)
    #               lhs: Bf'
    #               rhs: B
    #           - type: loop-until-all
    #             comment: falling
    #             children:
    #             - type: x-replace-only
    #               comment: falling tiles
    #               what: F
    #               with:
    #               - B
    #               - P
    #               children:
    #               - type: rewrite
    #                 comment: falling
    #                 lhs: F;_
    #                 rhs: _;F
    #               - type: rewrite
    #                 comment: fall into door
    #                 lhs: F;D
    #                 rhs: _;D
    #     - type: loop-until-all
    #       comment: set player direction
    #       children:
    #       - type: rewrite
    #         comment: right to left
    #         lhs: 
    #           main: . P>
    #           face: F P
    #         rhs: 
    #           main: . <P
    #       - type: rewrite
    #         comment: left to right
    #         lhs: 
    #           main: <P .
    #           face: P F
    #         rhs: 
    #           main: P> .
