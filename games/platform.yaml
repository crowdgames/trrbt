---
name: platformer
tree:
  type: sequence
  children:
  - type: set-board
    pattern: _   _   _   _   _   _   _   _   _ ;
             _   _   _   _   _   _   _   _   _ ;
             _   _   _   _   _   _   Q   _   _ ;
             _   _   _   _   _   _   _   _   _ ;
             _   _   _   _   E   _   _   _   _ ;
             P0  _   _   _   X   X   X   _   O ;
             X   X   X   X   X   X   X   X   X ;
  - type: x-replaceonly
    what: a
    with:
    - 0
    - 1
    - 2
    children:
    - type: loop-until-all
      nid: gameloop
      children:
      - type: player
        pid: 1
        children:
        - type: rewrite
          comment: player stays still
          lhs: Pa
          rhs: Pa
        - type: x-mirror
          comment: player moves to side
          children:
          - type: rewrite
            lhs: Pa  _
            rhs: _   Pa
          - type: rewrite
            lhs: Pa  O
            rhs: _   W
        - type: rewrite
          comment: player on ground jumps
          lhs: P0 ;X
          rhs: P2 ;X
      - type: loop-until-all
        comment: all enemies move, tagged
        children:
        - type: rewrite
          lhs: _   E
          rhs: E'  _
        - type: rewrite
          lhs: Pa  E
          rhs: E'   _
      - type: loop-until-all
        comment: enemy tags removed
        children:
        - type: rewrite
          lhs: E'
          rhs: E
      - type: loop-until-all
        comment: things fall into spaces, tagged
        children:
        - type: rewrite
          lhs: E  ;_
          rhs: _  ;E'
        - type: rewrite
          lhs: P0 ;_
          rhs: _  ;P0'
        - type: rewrite
          lhs: P0 ;O
          rhs: _  ;W
      - type: loop-until-all
        comment: things land on what's below them
        children:
        - type: rewrite
          lhs: E  ;Pa
          rhs: _  ;E'
        - type: rewrite
          lhs: P0 ;E
          rhs: _  ;P0'
      - type: loop-until-all
        comment: if jumping, player moves up or hits something
        children:
        - type: rewrite
          lhs: _  ;P1
          rhs: P0';_
        - type: rewrite
          lhs: X  ;P1
          rhs: X  ;P0'
        - type: rewrite
          lhs: Q  ;P1
          rhs: X  ;P0'
        - type: rewrite
          lhs: _  ;P2
          rhs: P1';_
        - type: rewrite
          lhs: X  ;P1
          rhs: X  ;P0'
        - type: rewrite
          lhs: Q  ;P1
          rhs: X  ;P0'
      - type: loop-until-all
        comment: tags removed
        children:
        - type: rewrite
          lhs: E'
          rhs: E
        - type: rewrite
          lhs: Pa'
          rhs: Pa
      - type: win
        comment: player wins if reached goal
        pid: 1
        children:
        - type: match
          pattern: W
      - type: lose
        comment: player loses if captured
        pid: 1
        children:
        - type: none
          children:
          - type: match
            pattern: Pa
