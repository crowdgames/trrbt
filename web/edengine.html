<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="common.js"></script>
    <script src="selector.js"></script>
    <script src="editor.js"></script>
    <script src="engine.js"></script>
    <script src="games/games.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  </head>
  <body>
    <script>
      var G_game_u = emptyGame();
      var G_game_x = emptyGame();
      var G_editor_u = new TRRBTEditor(G_game_u, SEL_getGameTree, 'editorucanvas', 'editorudiv', beforeGameNameChange, afterGameNameChange, beforePropsChange, afterPropsChange);
      var G_editor_x = new TRRBTEditor(G_game_x, SEL_getGameTree, 'editorxcanvas', null);
      var G_engine = new TRRBTWebEngine(G_game_x, 'enginecanvas', 'enginediv');
      var isTemplate = true;
      function onSelectGame(gameSelected, selectedTemplate) {
          isTemplate = selectedTemplate;
          if (G_editor_u.hasChanged) {
            // Save local copy
            var game = emptyGame();
            copyIntoGame(game, G_editor_u.game);
            LOCAL_GAME_SETUPS[game.name] = game;
          }
          G_editor_u.importGame(gameSelected);
          G_editor_u.hasChanged = false;
      }
      function beforeGameNameChange(oldName, newName) {
        if (oldName === newName) {
          return { ok: true };
        }
        if (LOCAL_GAME_SETUPS[newName]) {
          return { ok: false, error: "A local game already exists with name " + newName }
        }
        return { ok: true }
      }
      function afterGameNameChange(oldName, newName) {
        if (LOCAL_GAME_SETUPS[oldName]) {
          delete LOCAL_GAME_SETUPS[oldName];
          SEL_removeLocal(oldName);
        }
        // Save local copy
        var game = emptyGame();
        copyIntoGame(game, G_editor_u.game);
        // Add to options if not already
        if (!LOCAL_GAME_SETUPS[newName]) {
          SEL_addLocal(game);
        }
        LOCAL_GAME_SETUPS[newName] = game;
      }
      function beforePropsChange() {
        // Save local copy
        var game = emptyGame();
        copyIntoGame(game, G_editor_u.game);
        if (isTemplate) {
          result = beforeGameNameChange(undefined, game.name);
          if (!result.ok) {
            return { ok: false, error: result.error }
          }
        }
        return { ok: true };
      }
      function afterPropsChange() {
        isTemplate = false;
        var game = emptyGame();
        copyIntoGame(game, G_editor_u.game);
        if (!LOCAL_GAME_SETUPS[game.name]) {
          SEL_addLocal(game);
        }
        LOCAL_GAME_SETUPS[game.name] = game;
      }
      function onLoad() {
          copyIntoGame(G_game_u, SEL_startingGame());

          G_editor_u.xform_editor = G_editor_x;

          G_editor_x.engine = G_engine;
          G_engine.editor = G_editor_x;

          G_engine.onLoad();
          G_engine.stepManual = true;
          G_editor_x.onLoad();
          G_editor_u.onLoad();
      }
      window.addEventListener('load', onLoad, false);
    </script>
    <center>
      <table>
        <tbody>
          <tr style="vertical-align:top">
            <td>
              <canvas id="editorucanvas" width="800px" height="350px" tabindex="1">
                Browser does not support canvas.
              </canvas>
            </td>
            <td rowspan="2">
              <div id="editorudiv" style="width:400px; height:700px" tabindex="4">
              </div>
            </td>
            <td rowspan="2">
              <div id="selectordiv" style="width:400px; height:50px" tabindex="1">
              </div>
              <hr style="width:25%; margin-left:0"/>
              <div id="enginediv" style="width:400px; height:140px" tabindex="3">
              </div>
            </td>
            <td rowspan="2">
              <canvas id="enginecanvas" width="600px" height="600px" tabindex="5">
                Browser does not support canvas.
              </canvas>
            </td>
          </tr>
          <tr style="vertical-align:top">
            <td>
              <canvas id="editorxcanvas" width="800px" height="350px" tabindex="2">
                Browser does not support canvas.
              </canvas>
            </td>
          </tr>
        </tbody>
      </table>
    </center>
  </body>
</html>
