<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="common.js"></script>
    <script src="selector.js"></script>
    <script src="editor.js"></script>
    <script src="engine.js"></script>
    <script src="games/games.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <link rel="stylesheet" href="edengine.css">
  </head>
  <body>
    <script>
      var G_game_u = emptyGame();
      var G_game_x = emptyGame();
      var G_editor_u = new TRRBTEditor(G_game_u, SEL_getGameTree, 'editorucanvas', 'editorudiv', beforeSave, afterSave, onTemplate, onDeleteGame);
      var G_editor_x = new TRRBTEditor(G_game_x, SEL_getGameTree, 'editorxcanvas', null);
      var G_engine = new TRRBTWebEngine(G_game_x, 'enginecanvas', 'enginediv');
      var isTemplate = true;
      function onSelectGame(gameSelected, selectedTemplate) {
          isTemplate = selectedTemplate;
          G_editor_u.importGame(gameSelected);
      }
      function beforeSave(newProps) {
        if (newProps.has('name') && LOCAL_GAME_SETUPS[newProps.get('name')] 
        || isTemplate && !newProps.has('name') && LOCAL_GAME_SETUPS[G_editor_u.game['name']]) {
          let newName = G_editor_u.game['name'];
          if (newProps.has('name')) {
            newName = newProps.get('name');
          }
          return { ok: false, error: "A local game already exists with name \"" + newName + "\""}
        }
        return { ok: true }
      }
      function afterSave(oldProps) {
        var game = emptyGame();
        copyIntoGame(game, G_editor_u.game);
        if (!isTemplate && oldProps.has('name')) {
          if (LOCAL_GAME_SETUPS[oldProps.get('name')]) {
            delete LOCAL_GAME_SETUPS[oldProps.get('name')];
            SEL_removeLocal(oldProps.get('name'));
          }
        }
        
        LOCAL_GAME_SETUPS[game['name']] = game;
        SEL_update();
        localStorage.setItem("LOCAL_GAME_SETUPS", JSON.stringify(LOCAL_GAME_SETUPS));
        isTemplate = false;
      }
      function onTemplate() {
        var game = emptyGame();
        copyIntoGame(game, G_editor_u.game);
        let numCopies = 1;
        name = game['name'];
        while (LOCAL_GAME_SETUPS[game['name']]) {
          game['name'] = name + " (" + numCopies++ + ")";
        }
        
        LOCAL_GAME_SETUPS[game['name']] = game;
        SEL_update();
        localStorage.setItem("LOCAL_GAME_SETUPS", JSON.stringify(LOCAL_GAME_SETUPS))
        // console.log("local storage: ", JSON.stringify(localStorage.getItem("LOCAL_GAME_SETUPS")))
        // TODO: local storage needs strings.
        G_editor_u.importGame(game);
        isTemplate = false;
      }
      function onDeleteGame() {
        if (isTemplate) {
          alert("Can't delete template game " + G_editor_u.game['name'] + ".");
          return;
        } 
        delete LOCAL_GAME_SETUPS[G_editor_u.game['name']];
        localStorage.setItem("LOCAL_GAME_SETUPS", JSON.stringify(LOCAL_GAME_SETUPS))
        SEL_removeLocal(G_editor_u.game['name']);
        G_editor_u.importGame(emptyGame())
      }
      function onLoad() {
          copyIntoGame(G_game_u, SEL_startingGame());

          G_editor_u.xform_editor = G_editor_x;

          G_editor_x.engine = G_engine;
          G_engine.editor = G_editor_x;

          G_engine.onLoad();
          G_engine.stepManual = true;
          G_editor_x.onLoad();
          G_editor_u.onLoad();
      }
      function moveCard(id, dir) {
        card = document.getElementById(id);
        if (["left", "up"].includes(dir)) {
          console.log("card: " + card.id)
          console.log("parent: " + card.parentNode.id)
          console.log("previous: " + card.previousElementSibling?.id)
          card.parentNode.insertBefore(card, card.previousElementSibling);
        } else {
          console.log("card: " + card.id)
          console.log("parent: " + card.parentNode.id)
          console.log("next: " + card.nextElementSibling?.id)
          console.log("next next: " + card.nextElementSibling?.nextElementSibling?.id)
          card.parentNode.insertBefore(card, card.nextElementSibling?.nextElementSibling);
        }
      }
      window.addEventListener('load', onLoad, false);
    </script>
    <center>
      <div id="toolbar">
        <div id="selectordiv"></div>
      </div>
      <div id="editwindow">
        <div class="card-group">
          <div class="card-column" id="treecolumn">
            <div class="card-bar">
              <span class="card-title">Tree Views</span>
              <div class="card-button-group" id="treecolumnbuttons">
                <button class="card-button" onclick="moveCard('treecolumn', 'left')">⬅️</button>
                <button class="card-button" onclick="moveCard('treecolumn', 'right')">➡️</button>
              </div>
            </div>
            <div class="card-group">
              <div class="card" id="ucanvascard">
                <div class="card-bar">
                  <span class="card-title">Transformed Tree</span>
                  <div class="card-button-group">
                    <button class="card-button" onclick="moveCard('ucanvascard', 'up')">⬆️</button>
                    <button class="card-button" onclick="moveCard('ucanvascard', 'down')">⬇️</button>
                  </div>
                </div>
                <canvas id="editorucanvas" width="800px" height="350px">
                  Browser does not support canvas.
                </canvas>
              </div>
              <div id="xcanvascard" class="card">
                <div class="card-bar">
                  <span class="card-title">Untransformed Tree</span>
                  <div class="card-button-group">
                    <button class="card-button" onclick="moveCard('xcanvascard', 'up')">⬆️</button>
                    <button class="card-button" onclick="moveCard('xcanvascard', 'down')">⬇️</button>
                  </div>
                </div>
                <canvas id="editorxcanvas" width="800px" height="350px">
                  Browser does not support canvas.
                </canvas>
              </div>
            </div>
          </div>
          <div class="card-column" id="editorcolumn">
            <div id="editorcard" class="card" style="width: 400px">
              <div class="card-bar">
                <span class="card-title">Editor</span>
                <div class="card-button-group">
                  <button class="card-button" onclick="moveCard('editorcolumn', 'left')">⬅️</button>
                  <button class="card-button" onclick="moveCard('editorcolumn', 'right')">➡️</button>
                </div>
              </div>
              <div id="editorudiv"></div>
            </div>
          </div>
          <div class="card-column" id="enginecolumn">
            <div class="card-bar">
              <span class="card-title">Engine</span>
              <div class="card-button-group">
                <button class="card-button" onclick="moveCard('enginecolumn', 'left')">⬅️</button>
                <button class="card-button" onclick="moveCard('enginecolumn', 'right')">➡️</button>
              </div>
            </div>
            <div class="card-group">
              <div id="enginecanvascard" class="card">
                <div class="card-bar">
                  <span class="card-title">Game</span>
                  <div class="card-button-group">
                    <button class="card-button" onclick="moveCard('enginecanvascard', 'up')">⬆️</button>
                    <button class="card-button" onclick="moveCard('enginecanvascard', 'down')">⬇️</button>
                  </div>
                </div>
                <canvas id="enginecanvas" width="600px" height="600px" tabindex="5">
                  Browser does not support canvas.
                </canvas>
              </div>        
              <div id="enginecontrolscard" class="card">
                <div class="card-bar">
                  <span class="card-title">Controls</span>
                  <div class="card-button-group">
                    <button class="card-button" onclick="moveCard('enginecontrolscard', 'up')">⬆️</button>
                    <button class="card-button" onclick="moveCard('enginecontrolscard', 'down')">⬇️</button>
                  </div>
                </div>
                <div id="enginediv"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </center>
  </body>
</html>
